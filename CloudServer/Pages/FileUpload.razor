@page "/file-upload"
@using System.IO
@using Microsoft.AspNetCore.Hosting
@using System.Diagnostics
@using CloudServer.Logic
@using CloudServer.Components
@using File=CloudServer.Logic.File
@inject IWebHostEnvironment Environment

<h3>Upload Files</h3>

<p>
    <label>
        Upload up to @FileManager.Settings.MaxAllowedFiles of up to @FileManager.Settings.MaxFileSizeBytes bytes:
        <InputFile OnChange="@LoadFiles" multiple/>
    </label>
</p>

<EditForm EditContext="new EditContext(new object())">
    <label>
        Use FTP:
        <InputCheckbox @bind-Value="_useFtp"></InputCheckbox>
    </label>
</EditForm>


@if (_loadingFiles == null) {
    <p>Select some files to upload.</p>
}
else {
    <ol>
        @foreach (var file in _loadingFiles) {
            <UploadingFileComponent File="@file"/>
        }
    </ol>
}

@if (_uploadingTimeSeconds > 0) {
    <p>File uploading took: @($"{_uploadingTimeSeconds:F2}") seconds.</p>
}

@code {
    private string? _uploadDirectory;
    private string UploadDirectory => _uploadDirectory ??= Path.Combine(Environment.WebRootPath, "unsafe-uploads");
    private File[]? _loadingFiles;
        private const int ProgressRefreshRate = 100;

    // Statistics
    private double _uploadingTimeSeconds;
    private bool _useFtp;

    private async Task SignalRLoadFiles() {
        var fileTasks = new Task[_loadingFiles!.Length + 1];
        fileTasks[_loadingFiles.Length] = Refresh();
        for (var i = 0; i < _loadingFiles.Length; i++) {
            fileTasks[i] = FileManager.SignalR.UploadFileAsync(_loadingFiles[i], UploadDirectory);
        }

        await Task.WhenAll(fileTasks);
    }

    private async Task Refresh() {
        while (_loadingFiles?.Any(file => file.Status is FileUploadStatus.Uploading or FileUploadStatus.None) ?? false) {
            await Task.Delay(ProgressRefreshRate);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadFiles(InputFileChangeEventArgs e) {
        _uploadingTimeSeconds = 0;
        var sw = Stopwatch.StartNew();

        Directory.CreateDirectory(UploadDirectory);

        _loadingFiles = e
            .GetMultipleFiles(FileManager.Settings.MaxAllowedFiles)
            .Select(file => new File(file))
            .ToArray();

        if (_useFtp) {
            await FtpLoadFiles();
        }
        else {
            await SignalRLoadFiles();
        }

        sw.Stop();
        _uploadingTimeSeconds = sw.Elapsed.TotalSeconds;
    }

    private async Task FtpLoadFiles() {
        var fileTasks = new Task[_loadingFiles!.Length + 1];
        fileTasks[_loadingFiles.Length] = Refresh();
        for (var i = 0; i < _loadingFiles.Length; i++) {
            var localI = i;
            fileTasks[i] = Task.Run(() => FileManager.FileTransferProtocol.UploadFileAsync(_loadingFiles[localI], UploadDirectory));
        }

        await Task.WhenAll(fileTasks);
    }
}